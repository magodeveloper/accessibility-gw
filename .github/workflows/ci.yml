# CI para .NET 9 + Docker + cobertura de cÃ³digo
name: CI

# Ejecuta el workflow en push/PR a master y main, mÃ¡s schedule semanal
on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  schedule:
    - cron: "0 6 * * 1"
  workflow_dispatch:

jobs:
  build-test:
    runs-on: ubuntu-latest
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 3
    env:
      Redis__ConnectionString: localhost:6379
      ASPNETCORE_ENVIRONMENT: Development
      JwtSettings__SecretKey: test-secret-key-for-ci-must-be-at-least-32-characters-long
      JwtSettings__Issuer: https://api.accessibility.company.com
      JwtSettings__Audience: https://accessibility.company.com
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"
          cache: true
          cache-dependency-path: |
            **/*.csproj
            **/packages.lock.json

      - name: Restore dependencies
        run: dotnet restore Gateway.sln

      - name: Build
        run: dotnet build Gateway.sln --no-restore --configuration Release

      - name: Wait for Redis
        run: |
          echo "Waiting for Redis to be ready..."
          for i in {1..30}; do
            if timeout 1 bash -c "echo -e 'PING\r\n' | nc 127.0.0.1 6379" | grep -q PONG; then 
              echo "âœ… Redis is ready"
              exit 0
            fi
            echo "Attempt $i/30..."
            sleep 2
          done
          echo "âŒ Redis did not become ready in time"
          exit 1
        shell: bash

      - name: Run Unit Tests with coverage
        run: dotnet test src/tests/Gateway.UnitTests/Gateway.UnitTests.csproj --no-build --configuration Release --collect:"XPlat Code Coverage"

      - name: Run Integration Tests with coverage
        run: dotnet test src/tests/Gateway.IntegrationTests/Gateway.IntegrationTests.csproj --no-build --configuration Release --collect:"XPlat Code Coverage"

      - name: Report coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./src/tests/**/TestResults/**/*.cobertura.xml
          fail_ci_if_error: true
          token: ${{ secrets.CODECOV_TOKEN }}

  docker-build-test:
    name: "ðŸ³ Docker Build & Smoke Test"
    runs-on: ubuntu-latest
    needs: build-test
    timeout-minutes: 15
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 3
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          IMAGE=accessibility-gw-ci:${{ github.sha }}
          docker rm -f gateway-smoke || true
          docker build -t $IMAGE .
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV

      - name: Wait for Redis
        run: |
          echo "Waiting for Redis to be ready..."
          for i in {1..30}; do
            if timeout 1 bash -c "echo -e 'PING\r\n' | nc 127.0.0.1 6379" | grep -q PONG; then 
              echo "âœ… Redis is ready"
              exit 0
            fi
            echo "Attempt $i/30..."
            sleep 2
          done
          echo "âŒ Redis did not become ready in time"
          exit 1
        shell: bash

      - name: Run container
        run: |
          docker run -d --rm --name gateway-smoke \
            -p 8100:8080 \
            -e ASPNETCORE_ENVIRONMENT=Production \
            -e ASPNETCORE_URLS="http://+:8080" \
            -e Redis__ConnectionString="172.17.0.1:6379" \
            -e JwtSettings__SecretKey="test-secret-key-for-ci-must-be-at-least-32-characters-long" \
            -e JwtSettings__Issuer="https://api.accessibility.company.com" \
            -e JwtSettings__Audience="https://accessibility.company.com" \
            -e Gate__Services__users="http://localhost:8081" \
            -e Gate__Services__analysis="http://localhost:8082" \
            -e Gate__Services__reports="http://localhost:8083" \
            -e Gate__Services__middleware="http://localhost:3001" \
            -e HealthChecksUI__HealthChecks__0__Name="Gateway API" \
            -e HealthChecksUI__HealthChecks__0__Uri="http://localhost:8080/health" \
            "$IMAGE"

      - name: Wait for health
        shell: bash
        run: |
          for i in {1..30}; do
            if curl -fsS http://localhost:8100/health/live >/dev/null; then
              echo "Health is OK"; exit 0; fi;
            echo "Waiting for service... ($i/30)"; sleep 2;
          done
          if ! curl -fsS http://localhost:8100/health/live >/dev/null; then
            echo "Service didn't become healthy in time";
            echo "Container logs:";
            docker logs gateway-smoke 2>&1 | tee smoke.log || true;
            exit 1;
          fi

      - name: Run smoke tests
        shell: bash
        run: |
          echo "Testing health endpoints..."
          echo "âœ… Liveness check..."
          curl -fsS http://localhost:8100/health/live || exit 1

          echo ""
          echo "â„¹ï¸  Readiness check (expected to fail - no dependencies available):"
          curl -S http://localhost:8100/health/ready || echo "  âš ï¸  Readiness check failed as expected (no Redis/services in CI)"

          echo ""
          echo "âœ… Testing metrics endpoint..."
          curl -fsS http://localhost:8100/metrics || exit 1

          echo ""
          echo "âœ… All critical smoke tests passed"

      - name: Upload smoke logs if failed
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: gateway-smoke-logs
          path: smoke.log

      - name: Stop container
        if: always()
        run: docker stop gateway-smoke || true

  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    if: always()
    needs: [build-test, docker-build-test]
    steps:
      - name: Generate summary
        run: |
          echo "## CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Build & Tests: ${{ needs.build-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Docker Smoke: ${{ needs.docker-build-test.result }}" >> $GITHUB_STEP_SUMMARY
