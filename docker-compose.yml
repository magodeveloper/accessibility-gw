services:
  accessibility-gateway:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        BUILD_CONFIGURATION: Release
    image: accessibility-gateway:latest
    container_name: accessibility-gateway
    ports:
      - "8100:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      - Gate__Secret=VGhpc0lzQVNlY3JldEtleUZvckdhdGV3YXkyMDI0
      - Gate__Services__users=http://msusers-api:8081
      - Gate__Services__reports=http://msreports-api:8083
      - Gate__Services__analysis=http://msanalysis-api:8082
      - Gate__Services__intelligence=http://msintelligence-api:8084
      - Gate__Services__middleware=http://accessibility-mw:3001
      - Jwt__SecretKey=9b3e7ER@S^glvxPWKX8nN?DTqtrd%Yj!oVIfh+BG&piHwZz6ky4Q52MumOFA-Lc0
      - Jwt__Issuer=https://accessibility.company.com
      - Jwt__Audience=https://accessibility.company.com
      - Jwt__ValidateIssuer=false
      - Jwt__ValidateAudience=false
      - Redis__ConnectionString=redis:6379
      - Jwt__Authority=https://accessibility-auth:8100
      - Jwt__Audience=accessibility-gateway
      - DOTNET_ENVIRONMENT=Production
    depends_on:
      redis:
        condition: service_healthy
    volumes:
      - gateway-logs:/app/logs
      - /etc/localtime:/etc/localtime:ro
    networks:
      - accessibility-shared
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health/live || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
        reservations:
          cpus: "0.5"
          memory: 256M

  redis:
    image: redis:7.2-alpine
    container_name: accessibility-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
      - /etc/localtime:/etc/localtime:ro
    networks:
      - accessibility-shared
    restart: unless-stopped
    command: |
      redis-server 
      --appendonly yes 
      --appendfsync everysec 
      --maxmemory 256mb 
      --maxmemory-policy allkeys-lru 
      --tcp-keepalive 60 
      --timeout 0
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 64M

volumes:
  gateway-logs:
    driver: local
    name: accessibility-gateway-logs
  redis-data:
    driver: local
    name: accessibility-redis-data

networks:
  accessibility-shared:
    external: true
    name: accessibility-shared
