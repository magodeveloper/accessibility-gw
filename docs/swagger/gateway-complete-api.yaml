openapi: 3.0.3
info:
  title: Accessibility Platform API Gateway
  version: v1.0.0
  description: |
    API Gateway completo para la plataforma de accesibilidad que incluye todos los endpoints 
    de los microservicios y el middleware de análisis.
    
    ## Arquitectura
    
    El gateway actúa como punto de entrada único para:
    - **accessibility-ms-users**: Gestión de usuarios y autenticación
    - **accessibility-ms-reports**: Generación y gestión de reportes
    - **accessibility-ms-analysis**: Análisis de accesibilidad 
    - **accessibility-mw**: Middleware de análisis con herramientas especializadas
    
    ## Autenticación
    
    La mayoría de endpoints requieren autenticación JWT. Incluye el token en el header:
    ```
    Authorization: Bearer <jwt-token>
    ```
    
    ## Rate Limiting
    
    - **General**: 100 req/min por IP
    - **Análisis**: 20 req/min por IP (endpoints computacionalmente intensivos)
    
    ## Caché
    
    Los endpoints GET pueden ser cacheados por el gateway. Usa el parámetro `useCache=false` para evitar caché.
  contact:
    name: Accessibility Team
    email: accessibility@company.com
  license:
    name: MIT License

servers:
  - url: http://localhost:8000
    description: Desarrollo local
  - url: https://api.accessibility.company.com
    description: Producción

security:
  - bearerAuth: []

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT Authorization header using the Bearer scheme

  schemas:
    # ===== GATEWAY MODELS =====
    TranslateRequest:
      type: object
      required:
        - service
        - method
        - path
      properties:
        service:
          type: string
          enum: [users, reports, analysis, middleware]
          description: Nombre del servicio de destino
          example: users
        method:
          type: string
          enum: [GET, POST, PUT, PATCH, DELETE]
          description: Método HTTP
          example: GET
        path:
          type: string
          description: Ruta del endpoint
          example: /api/users/123
        query:
          type: object
          additionalProperties:
            type: string
          description: Parámetros de consulta
          example:
            page: "1"
            limit: "10"
        headers:
          type: object
          additionalProperties:
            type: string
          description: Headers HTTP personalizados
          example:
            Content-Type: application/json
        body:
          type: object
          description: Cuerpo de la petición (para POST, PUT, PATCH)
        useCache:
          type: boolean
          description: Indica si se debe usar caché (solo GET)
          default: true
        cacheExpiration:
          type: integer
          description: Tiempo de expiración del caché en minutos
          minimum: 1
          maximum: 1440
          example: 30

    HealthCheckRequest:
      type: object
      properties:
        deep:
          type: boolean
          description: Realizar verificación profunda de todos los servicios
          default: false
        includeMetrics:
          type: boolean
          description: Incluir métricas en la respuesta
          default: false

    HealthCheckResponse:
      type: object
      properties:
        status:
          type: string
          enum: [Healthy, Degraded, Unhealthy]
          description: Estado general del sistema
        totalDuration:
          type: string
          description: Duración total de la verificación
          example: "00:00:00.1234567"
        services:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/ServiceHealthStatus'
          description: Estado de cada servicio
        metrics:
          $ref: '#/components/schemas/GatewayMetrics'

    ServiceHealthStatus:
      type: object
      properties:
        status:
          type: string
          enum: [Healthy, Degraded, Unhealthy]
        description:
          type: string
        duration:
          type: string
          example: "00:00:00.0123456"
        data:
          type: object
          additionalProperties: true

    GatewayMetrics:
      type: object
      properties:
        totalRequests:
          type: integer
          description: Total de peticiones procesadas
          example: 12345
        requestsPerMinute:
          type: number
          format: double
          description: Promedio de peticiones por minuto
          example: 156.78
        averageResponseTime:
          type: number
          format: double
          description: Tiempo promedio de respuesta en ms
          example: 245.67
        errorRate:
          type: number
          format: double
          description: Porcentaje de errores
          minimum: 0
          maximum: 100
          example: 2.34
        cacheHitRate:
          type: number
          format: double
          description: Porcentaje de aciertos de caché
          minimum: 0
          maximum: 100
          example: 78.9
        serviceMetrics:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/ServiceMetrics'

    ServiceMetrics:
      type: object
      properties:
        requestCount:
          type: integer
          example: 2345
        averageResponseTime:
          type: number
          format: double
          example: 156.78
        errorCount:
          type: integer
          example: 23
        lastRequest:
          type: string
          format: date-time

    # ===== USERS SERVICE MODELS =====
    UserCreateDto:
      type: object
      required:
        - nickname
        - name
        - lastname
        - email
        - password
      properties:
        nickname:
          type: string
          maxLength: 50
          example: johndoe
        name:
          type: string
          maxLength: 100
          example: John
        lastname:
          type: string
          maxLength: 100
          example: Doe
        email:
          type: string
          format: email
          maxLength: 255
          example: john.doe@example.com
        password:
          type: string
          minLength: 8
          example: SecurePass123!

    UserReadDto:
      type: object
      properties:
        id:
          type: integer
          format: int64
          example: 123
        nickname:
          type: string
          example: johndoe
        name:
          type: string
          example: John
        lastname:
          type: string
          example: Doe
        email:
          type: string
          format: email
          example: john.doe@example.com
        role:
          type: string
          enum: [User, Admin, SuperAdmin]
          example: User
        status:
          type: string
          enum: [Active, Inactive, Suspended]
          example: Active
        emailConfirmed:
          type: boolean
          example: true
        lastLogin:
          type: string
          format: date-time
          nullable: true
        registrationDate:
          type: string
          format: date-time
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    UserUpdateDto:
      type: object
      properties:
        nickname:
          type: string
          maxLength: 50
        name:
          type: string
          maxLength: 100
        lastname:
          type: string
          maxLength: 100
        email:
          type: string
          format: email
          maxLength: 255

    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          example: user@example.com
        password:
          type: string
          example: password123

    LoginResponse:
      type: object
      properties:
        token:
          type: string
          description: JWT token de acceso
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        user:
          $ref: '#/components/schemas/UserReadDto'
        expiresAt:
          type: string
          format: date-time
          description: Fecha de expiración del token

    UserPreferences:
      type: object
      properties:
        id:
          type: integer
          format: int64
        userId:
          type: integer
          format: int64
        theme:
          type: string
          enum: [light, dark, auto]
          default: auto
        language:
          type: string
          enum: [es, en, fr, de]
          default: es
        notifications:
          type: boolean
          default: true
        accessibility:
          type: object
          properties:
            highContrast:
              type: boolean
              default: false
            fontSize:
              type: string
              enum: [small, medium, large, xlarge]
              default: medium
            reducedMotion:
              type: boolean
              default: false

    # ===== REPORTS SERVICE MODELS =====
    ReportCreateDto:
      type: object
      required:
        - title
        - analysisId
      properties:
        title:
          type: string
          maxLength: 200
          example: "Reporte de Accesibilidad - Homepage"
        description:
          type: string
          maxLength: 1000
          example: "Análisis completo de accesibilidad de la página principal"
        analysisId:
          type: integer
          format: int64
          example: 456

    ReportReadDto:
      type: object
      properties:
        id:
          type: integer
          format: int64
          example: 789
        title:
          type: string
          example: "Reporte de Accesibilidad - Homepage"
        description:
          type: string
        userId:
          type: integer
          format: int64
        analysisId:
          type: integer
          format: int64
        status:
          type: string
          enum: [Draft, InProgress, Completed, Failed]
          example: Completed
        generatedUrl:
          type: string
          format: uri
          nullable: true
          example: "https://reports.company.com/files/report-789.pdf"
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    # ===== ANALYSIS SERVICE MODELS =====
    AnalysisCreateDto:
      type: object
      required:
        - url
        - wcagLevel
      properties:
        url:
          type: string
          format: uri
          example: "https://example.com"
        title:
          type: string
          maxLength: 200
          example: "Análisis de Homepage"
        wcagLevel:
          type: string
          enum: [A, AA, AAA]
          default: AA
        includeScreenshot:
          type: boolean
          default: true

    AnalysisReadDto:
      type: object
      properties:
        id:
          type: integer
          format: int64
          example: 456
        url:
          type: string
          format: uri
        title:
          type: string
        userId:
          type: integer
          format: int64
        wcagLevel:
          type: string
          enum: [A, AA, AAA]
        status:
          type: string
          enum: [Pending, InProgress, Completed, Failed]
        score:
          type: number
          format: double
          minimum: 0
          maximum: 100
          example: 87.5
        violations:
          type: integer
          example: 5
        warnings:
          type: integer
          example: 12
        createdAt:
          type: string
          format: date-time
        completedAt:
          type: string
          format: date-time
          nullable: true

    # ===== MIDDLEWARE MODELS =====
    AnalyzeUrlRequest:
      type: object
      required:
        - url
      properties:
        url:
          type: string
          format: uri
          example: "https://example.com"
        tools:
          type: array
          items:
            type: string
            enum: [axe, equalAccess]
          default: [axe, equalAccess]
          example: [axe, equalAccess]
        wcagLevel:
          type: string
          enum: [A, AA, AAA]
          default: AA
        includeScreenshot:
          type: boolean
          default: true
        viewport:
          type: object
          properties:
            width:
              type: integer
              minimum: 320
              maximum: 1920
              default: 1280
            height:
              type: integer
              minimum: 240
              maximum: 1080
              default: 720
        timeout:
          type: integer
          minimum: 5000
          maximum: 120000
          default: 30000
          description: Timeout en milisegundos

    AnalyzeHtmlRequest:
      type: object
      required:
        - html
      properties:
        html:
          type: string
          example: "<!DOCTYPE html><html><head><title>Test</title></head><body><h1>Hello World</h1></body></html>"
        tools:
          type: array
          items:
            type: string
            enum: [axe, equalAccess]
          default: [axe, equalAccess]
        wcagLevel:
          type: string
          enum: [A, AA, AAA]
          default: AA
        baseUrl:
          type: string
          format: uri
          description: URL base para recursos relativos
          example: "https://example.com"

    AnalysisResult:
      type: object
      properties:
        id:
          type: string
          example: "analysis-123-456"
        url:
          type: string
          format: uri
        status:
          type: string
          enum: [completed, failed, pending]
        startTime:
          type: string
          format: date-time
        endTime:
          type: string
          format: date-time
        duration:
          type: number
          description: Duración en milisegundos
          example: 2345.67
        tools:
          type: object
          properties:
            axe:
              $ref: '#/components/schemas/AxeResult'
            equalAccess:
              $ref: '#/components/schemas/EqualAccessResult'
        summary:
          type: object
          properties:
            totalViolations:
              type: integer
              example: 5
            totalWarnings:
              type: integer
              example: 12
            score:
              type: number
              format: double
              minimum: 0
              maximum: 100
              example: 87.5
            level:
              type: string
              enum: [A, AA, AAA]
        screenshot:
          type: string
          format: uri
          nullable: true
          description: URL de la captura de pantalla
          example: "https://screenshots.company.com/analysis-123.png"

    AxeResult:
      type: object
      properties:
        violations:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
                example: color-contrast
              impact:
                type: string
                enum: [minor, moderate, serious, critical]
              description:
                type: string
              help:
                type: string
              nodes:
                type: array
                items:
                  type: object
                  properties:
                    html:
                      type: string
                    target:
                      type: array
                      items:
                        type: string
        passes:
          type: array
          items:
            type: object
        incomplete:
          type: array
          items:
            type: object

    EqualAccessResult:
      type: object
      properties:
        report:
          type: object
          properties:
            summary:
              type: object
              properties:
                violation:
                  type: integer
                potentialviolation:
                  type: integer
                recommendation:
                  type: integer
                potentialrecommendation:
                  type: integer
            results:
              type: array
              items:
                type: object
                properties:
                  ruleId:
                    type: string
                  level:
                    type: string
                    enum: [violation, potentialviolation, recommendation, potentialrecommendation]
                  message:
                    type: string
                  xpath:
                    type: string

    # ===== COMMON MODELS =====
    PaginatedResponse:
      type: object
      properties:
        data:
          type: array
          items: {}
        pagination:
          type: object
          properties:
            page:
              type: integer
              minimum: 1
              example: 1
            limit:
              type: integer
              minimum: 1
              maximum: 100
              example: 10
            total:
              type: integer
              example: 250
            totalPages:
              type: integer
              example: 25
            hasNext:
              type: boolean
              example: true
            hasPrevious:
              type: boolean
              example: false

    ApiResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "Operación completada exitosamente"
        data:
          type: object
        timestamp:
          type: string
          format: date-time

    ErrorResponse:
      type: object
      properties:
        error:
          type: object
          properties:
            code:
              type: string
              example: "VALIDATION_ERROR"
            message:
              type: string
              example: "Los datos proporcionados no son válidos"
            details:
              type: array
              items:
                type: object
                properties:
                  field:
                    type: string
                    example: "email"
                  message:
                    type: string
                    example: "El email no es válido"
        timestamp:
          type: string
          format: date-time

  responses:
    Unauthorized:
      description: No autorizado - Token JWT requerido o inválido
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    Forbidden:
      description: Prohibido - Permisos insuficientes
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    NotFound:
      description: Recurso no encontrado
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    ValidationError:
      description: Error de validación
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    RateLimitExceeded:
      description: Límite de velocidad excedido
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    ServerError:
      description: Error interno del servidor
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

paths:
  # ===== GATEWAY ENDPOINTS =====
  /api/v1/translate:
    post:
      tags: [Gateway]
      summary: Traducir petición a microservicio
      description: |
        Permite enviar peticiones HTTP a través del gateway hacia los microservicios configurados.
        
        **Rate Limit**: 100 req/min por IP
        
        **Servicios disponibles**:
        - `users`: Gestión de usuarios y autenticación
        - `reports`: Generación y gestión de reportes  
        - `analysis`: Análisis de accesibilidad
        - `middleware`: Herramientas avanzadas de análisis
      operationId: translateRequest
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TranslateRequest'
            examples:
              getUserList:
                summary: Obtener lista de usuarios
                value:
                  service: users
                  method: GET
                  path: /api/v1/users
                  query:
                    page: "1"
                    limit: "10"
                  useCache: true
              createReport:
                summary: Crear nuevo reporte
                value:
                  service: reports
                  method: POST
                  path: /api/report
                  body:
                    title: "Reporte de Accesibilidad"
                    analysisId: 123
              analyzeUrl:
                summary: Analizar URL con middleware
                value:
                  service: middleware
                  method: POST
                  path: /api/analyze/url
                  body:
                    url: "https://example.com"
                    tools: ["axe", "equalAccess"]
                    wcagLevel: "AA"
      responses:
        '200':
          description: Petición procesada exitosamente
          content:
            application/json:
              schema:
                type: object
                description: Respuesta del microservicio correspondiente
        '400':
          $ref: '#/components/responses/ValidationError'
        '403':
          $ref: '#/components/responses/Forbidden'
        '413':
          description: Payload demasiado grande
        '429':
          $ref: '#/components/responses/RateLimitExceeded'
        '502':
          description: Error en microservicio de destino
        '500':
          $ref: '#/components/responses/ServerError'

  /api/v1/services/{service}/{path}:
    get:
      tags: [Gateway]
      summary: Llamada directa GET a servicio
      description: Permite llamadas directas a servicios usando la ruta directa
      operationId: directServiceCallGet
      parameters:
        - name: service
          in: path
          required: true
          schema:
            type: string
            enum: [users, reports, analysis, middleware]
          example: users
        - name: path
          in: path
          required: true
          schema:
            type: string
          example: api/v1/users
      responses:
        '200':
          description: Respuesta del servicio
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/RateLimitExceeded'

    post:
      tags: [Gateway]
      summary: Llamada directa POST a servicio
      operationId: directServiceCallPost
      parameters:
        - name: service
          in: path
          required: true
          schema:
            type: string
            enum: [users, reports, analysis, middleware]
        - name: path
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Respuesta del servicio
        '201':
          description: Recurso creado
        '400':
          $ref: '#/components/responses/ValidationError'
        '403':
          $ref: '#/components/responses/Forbidden'

    put:
      tags: [Gateway]
      summary: Llamada directa PUT a servicio
      operationId: directServiceCallPut
      parameters:
        - name: service
          in: path
          required: true
          schema:
            type: string
            enum: [users, reports, analysis, middleware]
        - name: path
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Recurso actualizado
        '400':
          $ref: '#/components/responses/ValidationError'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags: [Gateway]
      summary: Llamada directa DELETE a servicio
      operationId: directServiceCallDelete
      parameters:
        - name: service
          in: path
          required: true
          schema:
            type: string
            enum: [users, reports, analysis, middleware]
        - name: path
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Recurso eliminado
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  # ===== HEALTH ENDPOINTS =====
  /health:
    get:
      tags: [Health]
      summary: Verificación de salud del gateway
      description: |
        Endpoint para verificar el estado de salud del gateway y sus dependencias.
        
        **Parámetros opcionales**:
        - `deep=true`: Verificación profunda de todos los servicios
        - `includeMetrics=true`: Incluir métricas en la respuesta
      operationId: healthCheck
      security: []
      parameters:
        - name: deep
          in: query
          description: Realizar verificación profunda
          schema:
            type: boolean
            default: false
        - name: includeMetrics
          in: query
          description: Incluir métricas en la respuesta
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Sistema saludable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthCheckResponse'
              example:
                status: Healthy
                totalDuration: "00:00:00.1234567"
                services:
                  self:
                    status: Healthy
                    description: Gateway principal
                    duration: "00:00:00.0012345"
                  service-users:
                    status: Healthy
                    description: Servicio de usuarios
                    duration: "00:00:00.0567890"
                  redis:
                    status: Healthy
                    description: Cache Redis
                    duration: "00:00:00.0123456"
        '503':
          description: Sistema no saludable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthCheckResponse'

  /health/live:
    get:
      tags: [Health]
      summary: Verificación de vida (liveness probe)
      description: Endpoint para Kubernetes liveness probe
      operationId: livenessCheck
      security: []
      responses:
        '200':
          description: Servicio vivo
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: healthy
                  timestamp:
                    type: string
                    format: date-time
        '503':
          description: Servicio no disponible

  /health/ready:
    get:
      tags: [Health]
      summary: Verificación de preparación (readiness probe)
      description: Endpoint para Kubernetes readiness probe
      operationId: readinessCheck
      security: []
      responses:
        '200':
          description: Servicio listo
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ready
                  timestamp:
                    type: string
                    format: date-time
        '503':
          description: Servicio no listo

  # ===== METRICS ENDPOINT =====
  /metrics:
    get:
      tags: [Monitoring]
      summary: Métricas del gateway
      description: |
        Obtiene las métricas de rendimiento y uso del gateway.
        
        Incluye información sobre:
        - Número total de peticiones
        - Tiempo promedio de respuesta
        - Tasa de errores
        - Tasa de aciertos de caché
        - Métricas por servicio
      operationId: getMetrics
      security: []
      responses:
        '200':
          description: Métricas del gateway
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GatewayMetrics'
              example:
                totalRequests: 12345
                requestsPerMinute: 156.78
                averageResponseTime: 245.67
                errorRate: 2.34
                cacheHitRate: 78.9
                serviceMetrics:
                  users:
                    requestCount: 4567
                    averageResponseTime: 123.45
                    errorCount: 12
                    lastRequest: "2025-08-30T19:30:00Z"
                  reports:
                    requestCount: 2345
                    averageResponseTime: 389.12
                    errorCount: 5
                    lastRequest: "2025-08-30T19:29:45Z"

tags:
  - name: Gateway
    description: Endpoints principales del gateway para traducción y enrutamiento
  - name: Health
    description: Endpoints de verificación de salud del sistema
  - name: Monitoring
    description: Endpoints de monitoreo y métricas
